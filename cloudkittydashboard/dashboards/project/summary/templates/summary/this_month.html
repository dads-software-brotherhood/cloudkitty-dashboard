{% load i18n %}
{% load l10n %}
{% load static %}
<script src='{% static "cloudkitty/js/d3.min.js" %}' type='text/javascript' charset='utf-8'></script>
<script src='{% static "cloudkitty/js/d3pie.min.js" %}' type='text/javascript' charset='utf-8'></script>
<script src='{% static "cloudkitty/js/rickshaw.min.js" %}' type='text/javascript' charset='utf-8'></script>

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">

<style>
    .square {
      height: 10px;
      width: 150px;
      background-color: #555;
    }
</style>

<script type="text/javascript">
  //palette = new Rickshaw.Color.Palette();
  //palette.color()

  var labels = {
    'compute' : {
      'label' : 'Compute service',
      'icon' : 'fa-server',
      'color' : '#2484c1'
    },
    'image' : {
      'label' : 'Image storage',
      'icon' : 'fa-hdd',
      'color' : '#65a620'
    },
    'volume' : {
      'label' : 'Volume storage',
      'icon' : 'fa-database',
      'color' : '#d8d23a'
    },
    'network.bw.in' : {
      'label' : 'Data download',
      'icon' : 'fa-cloud-download-alt',
      'color' : '#7b6888'
    },
    'network.bw.out' : {
      'label' : 'Data upload',
      'icon' : 'fa-cloud-upload-alt',
      'color' : '#961a1a'
    },
    'network.floating' : {
      'label' : 'Floating IP',
      'icon' : 'fa-wifi',
      'color' : '#a05d56'
    }
  }
</script>


<div class="col-md-12">
  <div class="col-md-6">
    <table class="table table-striped datatable">
      <caption>
        <span class="table-title">This month</span>
      </caption>
      <thead>
        <tr>
          <th colspan="2">
            <span>From <strong>{{date_start|date:"d/M/Y"}}</strong> to <strong>{{date_end|date:"d/M/Y"}}</strong></span>
          </th>
        </tr>
        <tr class="table_collumn_header">
          <th class="sortable anchor normal_column">Service</th>
          <th class="sortable normal_column">Cost</th>
        </tr>
      </thead>
      <tbody>
  {% for service, data in repartition_data.items %}
        <tr>
          <td class="sortable anchor normal_column">
            <div>
                <i class="fas" id="{{ service }}-icon"></i>
                <span id="{{ service }}-text">{{ service }}</span>
                <div id="{{ service }}-square" class="square"></div>
            </div>            
          </td>
          <td class="sortable normal_column">${{ data.cumulated|floatformat:2 }}</td>
        </tr>
  {% endfor %}
      </tbody>
      <tfoot>
        <tr>
            <td>
                <span>Total:</span>
            </td>
            <td>
                <span>${{ total|floatformat:2 }}</span>
            </td>
        </tr>
      </tfoot>
    </table>
  </div>

  <script type="text/javascript">
    for (x in labels) {
      span = document.getElementById(x + "-text");
      if (span) {
        span.innerHTML = labels[x].label;
      }
      square = document.getElementById(x + "-square");
      if (square) {
        square.style.backgroundColor = labels[x].color;
      }
      icon = document.getElementById(x + "-icon");
      if (icon) {
        icon.style.color = labels[x].color;
        icon.classList.add(labels[x].icon);  
      }
    }
  </script>

  <div class="col-md-6">
      <h4>{% trans "Cumulative Cost Repartition" %}</h4>
      <div id="repartition_cumulated"></div>
    </div>
  
    <script type="text/javascript">
      var cumulated = new d3pie("repartition_cumulated", {
        "size": {
          "canvasHeight": 450,
          "canvasWidth": 600
        },
        "labels": {
          "outer": {
            "pieDistance": 32
          },
          "inner": {
            "hideWhenLessThanPercentage": 3
          },
          "mainLabel": {
            "fontSize": 11
          },
          "percentage": {
            "color": "#ffffff",
            "decimalPlaces": 0
          },
          "value": {
            "color": "#adadad",
            "fontSize": 11
          },
          "lines": {
            "enabled": true
          },
          "truncation": {
            "enabled": true
          }
        },
        "effects": {
          "pullOutSegmentOnClick": {
            "effect": "linear",
            "speed": 400,
            "size": 8
          }
        },
        "misc": {
          "gradient": {
            "enabled": true,
            "percentage": 100
          }
        },
        "data": {
          "sortOrder": "value-desc",
          "content": [
    {% for service, data in repartition_data.items %}
            {"label": labels["{{ service }}"].label,
              "value": {{ data.cumulated|unlocalize }},
              "color": labels["{{ service }}"].color
            },
    {% endfor %}
        ]}});
    </script>
</div> 

<hr class="header_rule"></hr>

<div class="col-md-12">
  <h4>{% trans "Cost Per Service Per Hour" %}</h4>
  <div id="cost_progress"></div>
  <div id="cost_progress_legend"></div>
</div>

<script>
  var graph = new Rickshaw.Graph({
    element: document.querySelector('#cost_progress'),
    width: 800,
    height: 450,
    interpolation: 'linear',
    onComplete: function(w) {
      var legend = new Rickshaw.Graph.Legend({
        element: document.querySelector('#cost_progress_legend'),
        graph: w.graph
      });
    },
    series: [
  {% for service, data in repartition_data.items %}
      {
        color: labels["{{ service }}"].color,
        name: labels["{{ service }}"].label,
        data: [
        {% for timestamp, rating in data.hourly.items %}{x: {{ timestamp }}, y: {{ rating|unlocalize }}},{% endfor %}
        ]
      },
  {% endfor %}
    ]
  });
  graph.render();

  var hoverDetail = new Rickshaw.Graph.HoverDetail( {
      graph: graph
  } );

  var yAxis = new Rickshaw.Graph.Axis.Y({
      graph: graph,
  });
  yAxis.render();

  var xAxis = new Rickshaw.Graph.Axis.Time({
      graph: graph
  });
  xAxis.render();
</script>
